using Content.Client.UserInterface.Controls;
using Content.Shared._Impstation.StrangeMoods;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using Robust.Shared.Serialization.Manager;

namespace Content.Client._Impstation.StrangeMoods;

[GenerateTypedNameReferences]
public sealed partial class StrangeMoodInitUi : FancyWindow
{
    [Dependency] private readonly IPrototypeManager _proto = default!;
    [Dependency] private readonly ISerializationManager _serialization = default!;

    public event Action<StrangeMoodDefinition>? OnPresetAccepted;

    private List<StrangeMoodDefinition> _definitions = [];

    public StrangeMoodInitUi()
    {
        RobustXamlLoader.Load(this);
        MoodPresetDropDown.OnItemSelected += args => MoodPresetDropDown.SelectId(args.Id);
        AcceptPresetButton.OnPressed += _ => AcceptPreset();

        var definitions = _proto.EnumeratePrototypes<StrangeMoodDefinitionPrototype>();
        var i = 0;
        foreach (var proto in definitions)
        {
            MoodPresetDropDown.AddItem(proto.Name, i);

            var def = new StrangeMoodDefinition();
            _serialization.CopyTo(proto, ref def, notNullableOverride: true);
            _definitions.Insert(i++, def);
        }
    }

    private void AcceptPreset()
    {
        var id = MoodPresetDropDown.SelectedId;
        var def = _definitions[id];
        OnPresetAccepted?.Invoke(def);
    }
}
