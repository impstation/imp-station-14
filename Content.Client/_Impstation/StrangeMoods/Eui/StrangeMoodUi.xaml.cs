using Content.Client.UserInterface.Controls;
using Content.Shared._Impstation.StrangeMoods;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.XAML;

namespace Content.Client._Impstation.StrangeMoods.Eui;

[GenerateTypedNameReferences]
public sealed partial class StrangeMoodUi : FancyWindow
{
    public event Action? OnGenerate;
    public event Action? OnSave;
    public event Action<SharedMood>? OnSharedSelected;

    private List<StrangeMood> _moods = [];
    private List<SharedMood> _sharedMoods = [];

    public StrangeMoodUi()
    {
        RobustXamlLoader.Load(this);
        NewMoodButton.OnPressed += _ => AddNewMood();
        GenerateMoodButton.OnPressed += _ => OnGenerate?.Invoke();
        SaveButton.OnPressed += _ => OnSave?.Invoke();
        SharedMoodDropDown.OnItemSelected += args => OnItemSelected(args.Id);

        SharedMoodDropDown.AddItem(Loc.GetString("strange-moods-admin-ui-shared-mood-none"), -1);
    }

    public void AddNewMood(StrangeMood? mood = null)
    {
        var moodControl = new MoodContainer(mood);
        var index = _moods.Count;

        moodControl.OnMoveUp += () => MoveUp(index);
        moodControl.OnMoveDown += () => MoveDown(index);
        moodControl.OnDelete += () => Delete(index);

        MoodContainer.AddChild(moodControl);
        _moods.Add(new StrangeMood{ MoodName = "", MoodDesc = "" });
    }

    private void OnItemSelected(int id)
    {
        SharedMoodDropDown.SelectId(id);

        if (id == -1)
        {
            SetSharedMood(); // empty the shared mood
            return;
        }

        OnSharedSelected?.Invoke(_sharedMoods[id]);
    }

    public void PopulateDropDown(HashSet<SharedMood> sharedMoods, SharedMood? selectMood = null)
    {
        SharedMoodDropDown.Clear();
        SharedMoodDropDown.AddItem(Loc.GetString("strange-moods-admin-ui-shared-mood-none"), -1);

        var i = 0;
        foreach (var mood in sharedMoods)
        {
            SharedMoodDropDown.AddItem(mood.ProtoId ?? Loc.GetString("strange-moods-admin-ui-unknown"), i);

            if (selectMood != null && selectMood.ProtoId == mood.ProtoId)
                SharedMoodDropDown.SelectId(i);

            _sharedMoods.Insert(i++, mood);
        }
    }

    public List<StrangeMood> GetMoods(bool skipEmptyCheck = false)
    {
        var newMoods = new List<StrangeMood>();

        foreach (var control in MoodContainer.Children)
        {
            if (control is not MoodContainer moodControl)
                continue;

            var title = moodControl.MoodTitle;
            if (string.IsNullOrWhiteSpace(title) && !skipEmptyCheck)
                continue;

            var moodText = moodControl.MoodText;
            if (string.IsNullOrWhiteSpace(moodText) && !skipEmptyCheck)
                continue;

            var mood = new StrangeMood()
            {
                MoodName = title,
                MoodDesc = moodText,
            };

            newMoods.Add(mood);
        }

        return newMoods;
    }

    public SharedMood? GetSharedMood()
    {
        var id = SharedMoodDropDown.SelectedId;
        return id == -1 ? null : _sharedMoods[id];
    }

    private void MoveUp(int index)
    {
        if (index <= 0)
            return;

        _moods = GetMoods(true);
        (_moods[index], _moods[index - 1]) = (_moods[index - 1], _moods[index]);
        SetMoods(_moods);
    }

    private void MoveDown(int index)
    {
        if (index >= _moods.Count - 1)
            return;

        _moods = GetMoods(true);
        (_moods[index], _moods[index + 1]) = (_moods[index + 1], _moods[index]);
        SetMoods(_moods);
    }

    private void Delete(int index)
    {
        _moods.RemoveAt(index);

        _moods = GetMoods(true);
        SetMoods(_moods);
    }

    public void SetAllMoods(List<StrangeMood> moods, SharedMood? sharedMoods = null)
    {
        SetMoods(moods);
        SetSharedMood(sharedMoods);
    }

    public void SetMoods(List<StrangeMood> moods)
    {
        _moods = moods;
        MoodContainer.RemoveAllChildren();

        for (var i = 0; i < moods.Count; i++)
        {
            var index = i; // Copy for the closures
            var moodControl = new MoodContainer(moods[i]);
            moodControl.OnMoveUp += () => MoveUp(index);
            moodControl.OnMoveDown += () => MoveDown(index);
            moodControl.OnDelete += () => Delete(index);
            MoodContainer.AddChild(moodControl);
        }
    }

    public void SetSharedMood(SharedMood? sharedMood = null)
    {
        SharedMoodContainer.RemoveAllChildren();
        SharedMoodDropDown.SelectId(-1);

        if (sharedMood == null)
            return;

        for (var i = 0; i < _sharedMoods.Count; i++)
        {
            if (_sharedMoods[i].ProtoId != sharedMood.ProtoId)
                continue;

            _sharedMoods[i] = sharedMood;
            break;
        }

        foreach (var mood in sharedMood.Moods)
        {
            var moodControl = new MoodContainer(mood, true);
            SharedMoodContainer.AddChild(moodControl);
        }
    }
}
