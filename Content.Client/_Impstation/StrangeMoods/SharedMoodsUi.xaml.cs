using Content.Client.UserInterface.Controls;
using Content.Shared._Impstation.StrangeMoods;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;

namespace Content.Client._Impstation.StrangeMoods;

[GenerateTypedNameReferences]
public sealed partial class SharedMoodsUi : FancyWindow
{
    public event Action? OnCreateShared;
    public event Action? OnSave;
    public event Action<SharedMood>? OnSharedSelected;

    private List<StrangeMood> _moods = [];
    private List<SharedMood> _sharedMoods = [];

    public SharedMoodsUi()
    {
        RobustXamlLoader.Load(this);
        NewMoodButton.OnPressed += _ => AddNewMood();
        CreateSharedButton.OnPressed += _ => OnCreateShared?.Invoke();
        SaveButton.OnPressed += _ => OnSave?.Invoke();
        SharedMoodDropDown.OnItemSelected += args => SelectItem(args.Id);
    }

    public void AddNewMood(StrangeMood? mood = null)
    {
        var moodControl = new MoodContainer(mood);
        var index = _moods.Count;

        moodControl.OnMoveUp += () => MoveUp(index);
        moodControl.OnMoveDown += () => MoveDown(index);
        moodControl.OnDelete += () => Delete(index);

        MoodContainer.AddChild(moodControl);
        _moods.Add(new StrangeMood{ MoodName = "", MoodDesc = "" });
    }

    private void SelectItem(int id)
    {
        SharedMoodDropDown.SelectId(id);
        OnSharedSelected?.Invoke(_sharedMoods[id]);
    }

    public void PopulateDropDown(HashSet<SharedMood> sharedMoods, SharedMood? selectMood = null)
    {
        SharedMoodDropDown.Clear();
        _sharedMoods.Clear();

        var i = 0;
        foreach (var mood in sharedMoods)
        {
            SharedMoodDropDown.AddItem(mood.UniqueId ?? Loc.GetString("strange-moods-admin-ui-unknown"), i);
            _sharedMoods.Insert(i, mood);

            if (selectMood != null && selectMood.UniqueId == mood.UniqueId)
                SelectItem(i);

            i++;
        }

        if (selectMood == null && _sharedMoods.Count > 0)
            SelectItem(0); // auto-load a shared mood instead of opening a blank ui
    }

    public List<StrangeMood> GetMoods(bool skipEmptyCheck = false)
    {
        var newMoods = new List<StrangeMood>();

        foreach (var control in MoodContainer.Children)
        {
            if (control is not MoodContainer moodControl)
                continue;

            var title = moodControl.MoodTitle;
            if (string.IsNullOrWhiteSpace(title) && !skipEmptyCheck)
                continue;

            var moodText = moodControl.MoodText;
            if (string.IsNullOrWhiteSpace(moodText) && !skipEmptyCheck)
                continue;

            var mood = new StrangeMood()
            {
                MoodName = title,
                MoodDesc = moodText,
            };

            newMoods.Add(mood);
        }

        return newMoods;
    }

    public ProtoId<SharedMoodPrototype>? GetTargetMood()
    {
        return _sharedMoods[SharedMoodDropDown.SelectedId].UniqueId;
    }

    private void MoveUp(int index)
    {
        if (index <= 0)
            return;

        _moods = GetMoods(true);
        (_moods[index], _moods[index - 1]) = (_moods[index - 1], _moods[index]);
        SetMoods(_moods);
    }

    private void MoveDown(int index)
    {
        if (index >= _moods.Count - 1)
            return;

        _moods = GetMoods(true);
        (_moods[index], _moods[index + 1]) = (_moods[index + 1], _moods[index]);
        SetMoods(_moods);
    }

    private void Delete(int index)
    {
        _moods = GetMoods(true);
        _moods.RemoveAt(index);

        SetMoods(_moods);
    }

    public void SetMoods(List<StrangeMood> moods)
    {
        _moods = moods;
        MoodContainer.RemoveAllChildren();

        for (var i = 0; i < moods.Count; i++)
        {
            var index = i; // Copy for the closures
            var moodControl = new MoodContainer(moods[i]);
            moodControl.OnMoveUp += () => MoveUp(index);
            moodControl.OnMoveDown += () => MoveDown(index);
            moodControl.OnDelete += () => Delete(index);
            MoodContainer.AddChild(moodControl);
        }
    }
}
